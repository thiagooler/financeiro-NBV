<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate" />
    <meta http-equiv="Pragma" content="no-cache" />
    <meta http-equiv="Expires" content="0" />
    
    <title>NBV 18.8 - Precision Strike</title>
    <style>
        :root {
            --bg-dark: #0f1115;
            --bg-panel: #181b21;
            --primary: #00f2ff;
            --success: #00ff9d;
            --danger: #ff0055;
            --gold: #ffd700;
            --credit: #9d00ff;
            --text-main: #ffffff;
            --text-dim: #8b9bb4;
            --font-main: 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;
        }

        * { box-sizing: border-box; outline: none; -webkit-tap-highlight-color: transparent; }
        
        body {
            margin: 0; padding: 0;
            background-color: var(--bg-dark);
            color: var(--text-main);
            font-family: var(--font-main);
            overflow-x: hidden;
            display: flex; flex-direction: column; min-height: 100vh;
            padding-bottom: 90px;
        }

        h1, h2, h3 { margin: 0; font-weight: 700; }
        .text-green { color: var(--success); }
        .text-red { color: var(--danger); }
        .text-credit { color: var(--credit); }
        .flex { display: flex; }
        .hidden { display: none !important; }

        /* --- NAVIGATION --- */
        .nav-bar {
            display: flex; background: #000; padding: 5px; border-bottom: 1px solid #333;
            position: sticky; top: 0; z-index: 100;
        }
        .nav-btn {
            flex: 1; padding: 15px 5px; background: transparent; border: none; color: #666; 
            font-weight: bold; text-transform: uppercase; cursor: pointer; border-bottom: 3px solid transparent; font-size: 0.8rem;
        }
        .nav-btn.active { color: var(--primary); border-bottom-color: var(--primary); background: #111; }
        .badge { background: var(--danger); color: white; padding: 2px 6px; border-radius: 10px; font-size: 0.7rem; margin-left: 5px; }

        /* --- UI COMPONENTS --- */
        .btn-action {
            padding: 12px; border: none; border-radius: 6px; font-weight: bold; cursor: pointer; color: white;
            text-transform: uppercase; display: flex; align-items: center; justify-content: center; gap: 8px; transition: 0.2s;
        }
        .btn-action:active { transform: scale(0.95); }
        .btn-in { background: linear-gradient(135deg, #0ba360 0%, #3cba92 100%); }
        .btn-out { background: linear-gradient(135deg, #d62929 0%, #e66465 100%); }
        .btn-credit { background: linear-gradient(135deg, #7000ff 0%, #a64aff 100%); }
        .btn-ai { background: linear-gradient(135deg, #00f2ff 0%, #0078ff 100%); color: #000; box-shadow: 0 0 15px rgba(0, 242, 255, 0.3); }
        .btn-neutral { background: #333; border: 1px solid #555; }
        .btn-github { background: #24292e; border: 1px solid #555; }
        .btn-guardian { background: linear-gradient(135deg, #ffd700 0%, #ff8c00 100%); color: black; box-shadow: 0 0 15px rgba(255, 215, 0, 0.3); }
        .btn-danger { background: #ff0000; color: white; border: 1px solid #990000; }

        .btn-icon { background: #333; border: 1px solid #555; color: white; width: 35px; height: 35px; border-radius: 6px; cursor: pointer; display: flex; align-items: center; justify-content: center; }
        .btn-icon:hover { background: #555; }
        .btn-edit { background: #444; padding: 5px 10px; font-size: 0.8rem; border-radius: 4px; border: none; color: white; cursor: pointer; }

        /* --- DASHBOARD ELEMENTS --- */
        .master-box {
            background: linear-gradient(45deg, #1a1d24, #2a2e38);
            border: 1px solid var(--text-dim); margin: 20px;
            padding: 20px; border-radius: 12px;
            display: flex; justify-content: space-between; align-items: center;
        }
        .master-value { font-size: 2rem; color: white; font-weight: bold; }

        .boxes-grid {
            display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 15px; padding: 0 20px 20px 20px;
        }
        .box-card {
            background: var(--bg-panel); border: 1px solid #333; border-radius: 12px; padding: 15px;
            position: relative; display: flex; flex-direction: column; gap: 8px;
        }
        .box-card.negative { border-color: var(--danger) !important; box-shadow: 0 0 10px rgba(255, 0, 85, 0.2); }
        .box-card.credit-mode { border-color: var(--credit) !important; background: linear-gradient(180deg, #181b21 0%, #260f38 100%); }
        
        .box-val { font-size: 1.6rem; font-weight: bold; }

        .shield-track { height: 8px; background: #111; border-radius: 4px; overflow: hidden; display: flex; }
        .shield-segment { flex: 1; border-right: 1px solid #000; }
        .shield-fill { height: 100%; width: 0%; transition: width 0.5s; }
        .fill-lvl-1 { background: var(--success); } 
        .fill-lvl-future { background: var(--primary); }
        .fill-lvl-max { background: var(--gold); }
        
        .progress-track { height: 12px; background: #111; border-radius: 6px; overflow: hidden; position: relative; border: 1px solid #333; }
        .progress-bar { height: 100%; background: linear-gradient(90deg, var(--primary), var(--accent)); width: 0%; transition: width 1s; }

        .p-badge { padding: 2px 6px; border-radius: 4px; font-size: 0.65rem; font-weight: bold; margin-left: 5px; }
        .p-1 { background: var(--danger); color: white; border: 1px solid #ff5555; }
        .p-2 { background: var(--gold); color: black; border: 1px solid #ffee00; }
        .p-3 { background: var(--primary); color: black; border: 1px solid #00ccff; }

        .achievement-badge {
            background: rgba(255, 215, 0, 0.1); border: 1px solid var(--gold); color: var(--gold);
            padding: 5px; font-size: 0.7rem; border-radius: 4px; margin-top: 5px; display: inline-block;
            animation: pulse 2s infinite;
        }
        @keyframes pulse { 0% { opacity: 0.8; } 50% { opacity: 1; box-shadow: 0 0 10px rgba(255,215,0,0.3); } 100% { opacity: 0.8; } }

        /* --- BILLS --- */
        .bill-list { padding: 20px; display: flex; flex-direction: column; gap: 10px; }
        .bill-card {
            background: var(--bg-panel); border-left: 4px solid var(--danger); padding: 15px; border-radius: 8px;
            display: flex; flex-direction: column; gap: 10px;
        }
        .bill-card.auto-gen { border-left-color: var(--primary); background: rgba(0, 242, 255, 0.05); }
        .bill-card.deleting { opacity: 0.5; pointer-events: none; border-left-color: #555; }
        
        .bill-header { display: flex; justify-content: space-between; align-items: flex-start; }
        .bill-actions { display: flex; gap: 10px; margin-top: 5px; }

        /* --- REPORTS --- */
        .report-header { padding: 20px; background: #111; display: flex; flex-wrap: wrap; gap: 10px; align-items: flex-end; }
        .report-summary-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px; padding: 20px; }
        .summary-card { background: var(--bg-panel); padding: 15px; border-radius: 8px; text-align: center; border: 1px solid #333; }
        .summary-label { font-size: 0.75rem; color: #888; text-transform: uppercase; }
        .summary-val { font-size: 1.1rem; font-weight: bold; margin-top: 5px; }
        .chart-section { padding: 0 20px 20px 20px; }
        .bar-row { display: flex; align-items: center; margin-bottom: 8px; font-size: 0.85rem; }
        .bar-label { width: 100px; color: #ccc; }
        .bar-track { flex: 1; background: #111; height: 10px; border-radius: 5px; margin: 0 10px; overflow: hidden; }
        .bar-fill { height: 100%; background: var(--danger); }
        .bar-val { width: 80px; text-align: right; font-weight: bold; }
        .transaction-table { width: 100%; border-collapse: collapse; font-size: 0.85rem; }
        .transaction-table th { text-align: left; color: #666; padding: 5px; border-bottom: 1px solid #333; }
        .transaction-table td { padding: 8px 5px; border-bottom: 1px solid #222; }

        /* --- MODALS --- */
        .modal-overlay {
            position: fixed; inset: 0; background: rgba(0,0,0,0.95); z-index: 3000;
            display: flex; justify-content: center; align-items: center; opacity: 0; pointer-events: none; transition: 0.3s;
        }
        .modal-overlay.active { opacity: 1; pointer-events: all; }
        .modal-content {
            background: var(--bg-panel); width: 95%; max-width: 600px; padding: 25px;
            border-radius: 15px; border: 1px solid #444; max-height: 90vh; overflow-y: auto;
        }
        .form-input { width: 100%; padding: 12px; background: #0a0a0a; border: 1px solid #333; color: white; border-radius: 6px; margin-bottom: 10px; }
        .form-select { width: 100%; padding: 12px; background: #0a0a0a; border: 1px solid #333; color: white; border-radius: 6px; margin-bottom: 10px; }

        .invoice-row {
            display: flex; justify-content: space-between; align-items: center;
            background: #222; padding: 10px; margin-bottom: 5px; border-radius: 5px; border-left: 3px solid var(--text-dim);
        }

        .bottom-bar {
            position: fixed; bottom: 0; width: 100%; background: #111; padding: 10px; border-top: 1px solid #333;
            display: flex; gap: 5px; justify-content: space-around; z-index: 90;
        }
        
        #welcome-screen { position: fixed; inset: 0; background: var(--bg-dark); z-index: 2000; flex-direction: column; align-items: center; justify-content: center; display: flex; text-align: center;}
        
        /* Spinner */
        .spinner { border: 4px solid rgba(255,255,255,0.1); width: 36px; height: 36px; border-radius: 50%; border-left-color: var(--primary); animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        
        .status-pill { position: fixed; top: 10px; right: 10px; padding: 5px 10px; border-radius: 20px; font-size: 0.7rem; z-index: 4000; font-weight: bold; display: flex; align-items: center; gap: 5px; opacity: 0.9; box-shadow: 0 0 10px rgba(0,0,0,0.5); }
        .status-sync { background: var(--gold); color: #000; }
        .status-saved { background: var(--success); color: #000; }
        .status-error { background: var(--danger); color: white; }

        #global-loading { position:fixed; inset:0; background:rgba(0,0,0,0.8); z-index:9999; display:none; justify-content:center; align-items:center; flex-direction:column; }
        #modal-github { z-index: 3100; }
        .step-box { background: #222; padding: 15px; border-radius: 8px; margin-bottom: 15px; border-left: 4px solid var(--primary); }
    </style>
</head>
<body>

    <div id="status-indicator" class="status-pill hidden"></div>
    <div id="global-loading"><div class="spinner"></div><h3 style="margin-top:10px;">Salvando no Cofre...</h3><small style="color:#aaa">Garantindo integridade dos dados.</small></div>

    <div id="welcome-screen">
        <h1 style="color: var(--primary); font-size: 3rem; margin-bottom: 10px;">NBV 18.8</h1>
        <p style="color: var(--text-dim); margin-bottom: 40px;">Precision Strike</p>
        
        <div id="welcome-btns" class="flex" style="gap: 15px; flex-direction: column;">
            <button class="btn-action btn-github" onclick="attemptGithubLoad()">
                üîÑ Conectar GitHub (API)
            </button>
            <button class="btn-action btn-neutral" onclick="openGithubConfig()">
                ‚öôÔ∏è Configurar / Reset
            </button>
            <label class="btn-action btn-neutral" style="padding: 10px;">
                üìÇ Carregar Arquivo
                <input type="file" accept=".json" style="display: none;" onchange="loadFile(this)">
            </label>
        </div>
        <div id="welcome-loading" class="hidden">
            <div class="spinner"></div>
            <p style="margin-top:10px; color:#666;">Conectando ao Cofre...</p>
        </div>
    </div>

    <div id="app" class="hidden">
        
        <div class="nav-bar">
            <button class="nav-btn active" onclick="switchTab('dashboard')" id="btn-dash">üìä Dashboard</button>
            <button class="nav-btn" onclick="switchTab('bills')" id="btn-bills">‚ö†Ô∏è Pend√™ncias <span id="bill-badge" class="badge hidden">0</span></button>
            <button class="nav-btn" onclick="switchTab('reports')" id="btn-reports">üìà Relat√≥rios</button>
        </div>

        <div id="tab-dashboard">
            <div class="master-box">
                <div>
                    <div style="color:var(--text-dim); font-size:0.8rem;">CAIXA MESTRA</div>
                    <div class="master-value" id="master-balance">R$ 0,00</div>
                </div>
                <button class="btn-action btn-ai" onclick="openManualAIDistribution()">‚ö° IA Distribuir</button>
            </div>
            
            <div class="boxes-grid" id="boxes-container"></div>
        </div>

        <div id="tab-bills" class="hidden">
            <div style="padding: 20px; display: flex; justify-content: space-between; align-items: center;">
                <div>
                    <h3>Contas & Faturas</h3>
                    <small style="color:#666">Gerencie seus compromissos</small>
                </div>
                <div style="display:flex; gap:5px">
                    <button class="btn-action btn-credit" onclick="payInvoice()">üí≥ Pagar Fatura</button>
                    <button class="btn-action btn-out" onclick="openBillModal()">+ Manual</button>
                </div>
            </div>
            <div id="bill-list" class="bill-list"></div>
        </div>

        <div id="tab-reports" class="hidden">
            <div class="report-header">
                <div><label style="color:#666; font-size:0.7rem;">In√≠cio</label><input type="date" id="rep-start" class="form-input" style="padding:5px; margin:0; font-size:0.8rem"></div>
                <div><label style="color:#666; font-size:0.7rem;">Fim</label><input type="date" id="rep-end" class="form-input" style="padding:5px; margin:0; font-size:0.8rem"></div>
                <div style="display:flex; gap:5px;">
                    <button class="btn-action btn-ai" style="padding:8px 15px; font-size:0.8rem;" onclick="generateReport()">Filtrar</button>
                    <button class="btn-action btn-neutral" style="padding:8px 15px; font-size:0.8rem;" onclick="exportCSV()">üìÑ Excel/CSV</button>
                </div>
            </div>
            <div class="report-summary-grid">
                <div class="summary-card" style="border-bottom: 3px solid var(--success)"><div class="summary-label">Entradas</div><div class="summary-val text-green" id="rep-in">R$ 0,00</div></div>
                <div class="summary-card" style="border-bottom: 3px solid var(--danger)"><div class="summary-label">Sa√≠das</div><div class="summary-val text-red" id="rep-out">R$ 0,00</div></div>
                <div class="summary-card" style="border-bottom: 3px solid white"><div class="summary-label">Resultado</div><div class="summary-val" id="rep-bal">R$ 0,00</div></div>
            </div>
            <div class="chart-section"><h3 style="margin-bottom:15px; color:var(--text-dim)">Gastos por Caixinha</h3><div id="chart-box-expenses"></div></div>
            <div class="chart-section"><h3 style="margin-bottom:15px; color:var(--text-dim)">Top Gastos</h3><div id="chart-top-desc"></div></div>
            <div class="chart-section"><h3 style="margin-bottom:15px; color:var(--text-dim)">Extrato</h3>
                <div style="max-height: 300px; overflow-y: auto;">
                    <table class="transaction-table"><thead><tr><th>Data</th><th>Desc.</th><th>Caixa/Origem</th><th style="text-align:right">Valor</th></tr></thead><tbody id="rep-table-body"></tbody></table>
                </div>
            </div>
        </div>

        <div class="bottom-bar">
            <button class="btn-action btn-in" style="flex:1" onclick="openTransModal('in')">‚ûï</button>
            <button class="btn-action btn-out" style="flex:1" onclick="openTransModal('out')">‚ûñ</button>
            <button class="btn-action btn-guardian" style="flex:2" onclick="openGuardianModal()">üõ°Ô∏è Guardi√£o</button>
            <button class="btn-action btn-neutral" style="flex:1" onclick="forceSaveGitHub()">üíæ</button>
            <button class="btn-action btn-neutral" style="flex:1" onclick="openConfigModal()">‚öôÔ∏è</button>
        </div>
    </div>

    <div id="modal-guardian" class="modal-overlay">
        <div class="modal-content" style="border: 2px solid var(--gold);">
            <h2 style="color:var(--gold); text-align:center; text-transform:uppercase;">üõ°Ô∏è Or√°culo de Gastos</h2>
            <div id="guardian-step-1">
                <label style="color:#aaa">Item</label><input type="text" id="g-item" class="form-input" placeholder="O que comprar?">
                <label style="color:#aaa">Valor (R$)</label><input type="number" id="g-price" class="form-input" placeholder="0.00">
                <label style="color:#aaa">Motivo</label><input type="text" id="g-reason" class="form-input" placeholder="Por que?">
                <div class="step-box" style="margin-top:15px;"><strong style="color:var(--primary)">1. Copie:</strong><textarea id="g-prompt-out" class="form-input" style="height:60px; font-size:0.7rem;" readonly></textarea><button class="btn-action btn-neutral" style="width:100%" onclick="generateGuardianPrompt()">üìã Copiar Comando</button></div>
                <div class="step-box" style="margin-top:15px; border-left-color:var(--success)"><strong style="color:var(--success)">2. Cole JSON:</strong><textarea id="g-json-in" class="form-input" style="height:60px;" placeholder="Cole o JSON da IA..."></textarea><button class="btn-action btn-guardian" style="width:100%" onclick="processGuardianResponse()">üîÆ Analisar</button></div>
            </div>
            <div id="guardian-result" class="hidden">
                <div id="g-verdict-box" style="padding:20px; border-radius:10px; text-align:center; margin-bottom:20px;"><h3 id="g-verdict-title" style="font-size:1.5rem; margin-bottom:10px;"></h3><p id="g-verdict-text" style="font-size:1rem;"></p><div id="g-suggested-box" style="color:var(--primary); font-weight:bold; margin-top:10px; font-size:0.9rem;"></div></div>
                <div class="flex" style="gap:10px;"><button class="btn-action btn-in" style="flex:1" onclick="recordVictory()">üõ°Ô∏è Resistir</button><button class="btn-action btn-out" style="flex:1; background:#333; border:1px solid #555;" onclick="confirmGuardianSpend()">üí∏ Comprar</button></div>
            </div>
            <button class="btn-action btn-neutral" style="width:100%; margin-top:15px;" onclick="closeModals()">Fechar</button>
        </div>
    </div>

    <div id="modal-manual-ai" class="modal-overlay">
        <div class="modal-content">
            <h2 class="text-primary">‚ö° Estrategista</h2>
            <div class="step-box"><strong style="color:var(--gold)">Passo 1:</strong> Copie o comando.<textarea id="ai-prompt-output" class="form-input" style="height:80px; margin-top:5px; font-size:0.7rem; color:#aaa;" readonly></textarea><button class="btn-action btn-neutral" style="width:100%" onclick="copyPrompt()">üìã Copiar</button></div>
            <div class="step-box" style="border-left-color: var(--success);"><strong style="color:var(--success)">Passo 2:</strong> Cole a estrat√©gia.<textarea id="ai-json-input" class="form-input" style="height:80px; margin-top:5px;" placeholder='Cole o JSON...'></textarea><button class="btn-action btn-in" style="width:100%" onclick="processManualAI()">üöÄ Executar</button></div>
            <button class="btn-action btn-neutral" style="width:100%; margin-top:10px" onclick="closeModals()">Cancelar</button>
        </div>
    </div>

    <div id="modal-distribute" class="modal-overlay">
        <div class="modal-content">
            <h2 class="text-green">Confirmar Estrat√©gia</h2>
            <div id="ai-insight" style="background:#222; padding:10px; border-left:4px solid var(--primary); margin-bottom:10px; font-size:0.9rem; color:#fff; font-style:italic;"></div>
            <div id="distribution-list" style="margin: 15px 0;"></div>
            <div style="text-align:right; border-top:1px solid #333; padding-top:10px;">Total: <strong id="dist-total-alloc">R$ 0,00</strong> | Resta: <span id="dist-remain">R$ 0,00</span></div>
            <button class="btn-action btn-ai" style="width: 100%; margin-top: 15px;" onclick="commitDistribution()">Confirmar</button>
            <button class="btn-action btn-neutral" style="width:100%; margin-top:10px;" onclick="closeModals()">Cancelar</button>
        </div>
    </div>

    <div id="modal-github" class="modal-overlay">
        <div class="modal-content">
            <h2 class="text-primary">‚öôÔ∏è Configura√ß√£o GitHub</h2>
            <label style="color:#aaa">Token (PAT - Classic)</label><input type="password" id="gh-token" class="form-input" placeholder="ghp_xxxxxxxxxxxx">
            <label style="color:#aaa">Usu√°rio GitHub</label><input type="text" id="gh-user" class="form-input" placeholder="Ex: usuario123">
            <label style="color:#aaa">Nome do Reposit√≥rio</label><input type="text" id="gh-repo" class="form-input" placeholder="Ex: financeiro-nbv">
            <label style="color:#aaa">Nome do Arquivo (JSON)</label><input type="text" id="gh-file" class="form-input" value="nbv_data.json">
            <button class="btn-action btn-danger" style="width:100%; margin-bottom:15px; margin-top:10px;" onclick="forceReconnect()">üöë Reset Total (Nuclear)</button>
            <button class="btn-action btn-in" style="width:100%" onclick="saveGithubConfig()">Salvar Credenciais</button>
            <button class="btn-action btn-neutral" style="width:100%; margin-top:10px" onclick="closeModals()">Fechar</button>
        </div>
    </div>

    <div id="modal-invoice" class="modal-overlay"><div class="modal-content"><h2 class="text-white">Pagar Fatura</h2><div style="margin-top:10px;">Total Aberto: <strong id="inv-total" style="color:var(--credit)">R$ 0,00</strong></div><div id="inv-breakdown-list" style="max-height: 250px; overflow-y: auto;"></div><div style="text-align:right;">Total: <strong id="inv-pay-total" class="text-green">R$ 0,00</strong></div><button class="btn-action btn-credit" onclick="commitInvoicePay()">Confirmar</button><button class="btn-action btn-neutral" onclick="closeModals()">Cancelar</button></div></div>
    <div id="modal-pay-confirm" class="modal-overlay"><div class="modal-content"><h2 class="text-green">Confirmar</h2><div id="pay-desc-display" style="font-weight:bold;"></div><div id="pay-val-expected"></div><input type="number" id="pay-val-real" class="form-input"><select id="pay-method" class="form-select"><option value="cash">Saldo Caixa</option><option value="credit">Cart√£o</option></select><input type="hidden" id="pay-id-target"><button class="btn-action btn-in" onclick="commitPayment()">Baixar</button><button class="btn-action btn-neutral" onclick="closePayModal()">Cancelar</button></div></div>
    <div id="modal-bill" class="modal-overlay"><div class="modal-content"><h2 class="text-red">Conta</h2><input type="hidden" id="b-id"><input type="text" id="b-desc" class="form-input" placeholder="Desc"><input type="number" id="b-val" class="form-input" placeholder="Valor"><input type="date" id="b-date" class="form-input"><select id="b-box" class="form-select"></select><button class="btn-action btn-out" onclick="saveBill()">Salvar</button><button class="btn-action btn-neutral" onclick="closeModals()">Cancelar</button></div></div>
    <div id="modal-trans" class="modal-overlay"><div class="modal-content"><h2 id="t-title"></h2><input type="number" id="t-amt" class="form-input" placeholder="R$"><input type="text" id="t-desc" class="form-input" placeholder="Desc"><div id="box-select-div" class="hidden"><label>Origem</label><select id="t-box" class="form-select" onchange="checkSourceSelected(this)"></select><div id="ref-box-div" class="hidden"><label>Ref</label><select id="t-ref-box" class="form-select"></select></div></div><button class="btn-action btn-in" onclick="commitTrans()">Confirmar</button><button class="btn-action btn-neutral" onclick="closeModals()">Cancelar</button></div></div>
    <div id="modal-config" class="modal-overlay"><div class="modal-content"><div class="flex" style="justify-content:space-between"><h2>Config</h2><button class="btn-action btn-in" style="padding:5px" onclick="addNewBox()">+ Caixa</button></div><button class="btn-action btn-github" style="width:100%; margin-top:15px" onclick="openGithubConfig()">üîß GitHub</button><div id="config-list" style="margin-top:15px; max-height:300px; overflow-y:auto"></div><button class="btn-action btn-neutral" style="width:100%; margin-top:10px;" onclick="closeConfigModal()">Fechar</button></div></div>
    
    <div id="modal-detail" class="modal-overlay">
        <div class="modal-content">
            <h2 id="detail-title"></h2>
            <select id="box-mode-select" class="form-select" onchange="updateBoxMode(this.value)"><option value="monthly">Fluxo</option><option value="target">Meta</option><option value="credit">Cr√©dito</option></select>
            <div id="credit-settings" class="hidden"><input type="number" id="box-due-day" class="form-input" placeholder="Dia Venc."></div>
            <div id="subitems-area">
                <div id="subitems-list"></div>
                <div style="background:#222; padding:10px; margin-top:10px;">
                    <h4>+ Item</h4>
                    <input type="text" id="new-item-name" class="form-input" placeholder="Nome">
                    <div class="flex" style="gap:5px"><input type="number" id="new-item-val" class="form-input" placeholder="Valor"><select id="new-item-freq" class="form-select"><option value="monthly">Mensal</option><option value="annual">Anual</option><option value="custom">Parc.</option></select></div>
                    <div class="flex" style="gap:5px; margin-top:5px"><input type="number" id="new-item-day" class="form-input" placeholder="Dia"><select id="new-item-priority" class="form-select"><option value="3">P3</option><option value="2">P2</option><option value="1">P1</option></select></div>
                    <input type="number" id="new-item-parts" class="form-input hidden" placeholder="Parcelas">
                    <button class="btn-action btn-in" onclick="addSubItem()">Adicionar</button>
                </div>
                <div style="text-align:right; margin-top:15px;">Meta/Aporte: <strong id="detail-total" class="text-green">R$ 0,00</strong></div>
            </div>
            <button class="btn-action btn-neutral" style="width:100%; margin-top:15px;" onclick="closeDetailModal()">Voltar</button>
        </div>
    </div>

    <script>
        // --- CORE DATA & LOGIC ---
        let appData = { masterBalance: 0, boxes: [], bills: [], transactions: [] };
        let currentSha = null; let isSaving = false; let transType = 'in'; let currentBoxIdx = null;
        let guardianSuggestedBoxId = null; 

        // --- INIT SYSTEM ---
        function initNewSystem() {
            document.getElementById('welcome-screen').classList.add('hidden');
            document.getElementById('app').classList.remove('hidden');
            const now = new Date();
            const startStr = new Date(now.getFullYear(), now.getMonth(), 1).toISOString().split('T')[0];
            const endStr = now.toISOString().split('T')[0];
            if(document.getElementById('rep-start')) document.getElementById('rep-start').value = startStr;
            if(document.getElementById('rep-end')) document.getElementById('rep-end').value = endStr;
            sanitizeBills(); autoGenerateBills(); 
            if(typeof renderDashboard === 'function') renderDashboard();
            if(typeof renderBills === 'function') renderBills();
        }

        // --- RECALC DIST (RESTORED) ---
        function recalcDist() {
            let total = 0;
            document.querySelectorAll('.dist-inp').forEach(i => total += parseFloat(i.value || 0));
            document.getElementById('dist-total-alloc').innerText = fmt(total);
            document.getElementById('dist-remain').innerText = fmt(appData.masterBalance - total);
        }

        // --- GUARDIAN LOGIC ---
        function openGuardianModal() {
            document.getElementById('g-item').value = ''; document.getElementById('g-price').value = ''; document.getElementById('g-reason').value = ''; document.getElementById('g-prompt-out').value = ''; document.getElementById('g-json-in').value = '';
            document.getElementById('guardian-step-1').classList.remove('hidden'); document.getElementById('guardian-result').classList.add('hidden'); document.getElementById('modal-guardian').classList.add('active'); guardianSuggestedBoxId = null;
        }

        function generateGuardianPrompt() {
            const item = document.getElementById('g-item').value;
            const price = document.getElementById('g-price').value;
            const reason = document.getElementById('g-reason').value;
            if(!item || !price) return alert("Preencha o que e quanto!");
            
            // STRICT BILLS FILTER: Only count bills currently in the PENDING list (appData.bills)
            const urgentBills = appData.bills.reduce((sum, b) => sum + b.val, 0);
            
            const context = {
                item: item,
                price: parseFloat(price),
                reason: reason,
                master_balance: appData.masterBalance,
                ACTUAL_PENDING_BILLS_TOTAL: urgentBills,
                pending_bills_list: appData.bills.map(b => `${b.desc} (${fmt(b.val)})`),
                box_structure_reference_only: appData.boxes.map(b => ({
                    name: b.label,
                    balance: b.current,
                    projects: b.subItems.map(s => ({name: s.name, priority: s.priority || 3}))
                }))
            };

            const prompt = `Sou o Thiago (Warrior, TDAH). Quero comprar algo fora do plano.\nDADOS COMPLETOS:\n${JSON.stringify(context)}\nMISS√ÉO:\n1. Analise se posso comprar o item '${item}' por R$ ${price}.\n2. IMPORTANTE: Use apenas 'ACTUAL_PENDING_BILLS_TOTAL' e 'pending_bills_list' para saber o que devo. Ignore itens em 'box_structure_reference_only' se n√£o estiverem na lista de pend√™ncias (significa que j√° paguei).\n3. Se aprovado, diga de qual caixa devo tirar o dinheiro.\nResponda APENAS JSON:\n{\n  "verdict": "APROVADO" ou "NEGADO",\n  "message": "Explica√ß√£o curta.",\n  "safe_to_spend": true/false,\n  "suggested_box_name": "Nome Exato da Caixa Sugerida (ou null)"\n}`;
            const txt = document.getElementById('g-prompt-out');
            txt.value = prompt; txt.select(); document.execCommand('copy'); alert("Copiado! Cole na IA e traga a resposta.");
        }

        function processGuardianResponse() {
            try {
                let raw = document.getElementById('g-json-in').value;
                let clean = raw.replace(/```json/g, '').replace(/```/g, '').trim();
                const json = JSON.parse(clean);
                const box = document.getElementById('g-verdict-box');
                const title = document.getElementById('g-verdict-title');
                const text = document.getElementById('g-verdict-text');
                const suggestDiv = document.getElementById('g-suggested-box');

                if(json.safe_to_spend) {
                    box.style.background = 'rgba(0, 255, 157, 0.2)'; box.style.border = '2px solid var(--success)'; title.innerText = "‚úÖ " + json.verdict; title.style.color = 'var(--success)';
                    if(json.suggested_box_name) {
                        const matchedBox = appData.boxes.find(b => b.label.toLowerCase() === json.suggested_box_name.toLowerCase());
                        if(matchedBox) { guardianSuggestedBoxId = matchedBox.id; suggestDiv.innerText = `Fonte Recomendada: ${matchedBox.label} (Saldo: ${fmt(matchedBox.current)})`; } 
                        else { suggestDiv.innerText = `Fonte Sugerida: ${json.suggested_box_name}`; }
                    }
                } else {
                    box.style.background = 'rgba(255, 0, 85, 0.2)'; box.style.border = '2px solid var(--danger)'; title.innerText = "‚õî " + json.verdict; title.style.color = 'var(--danger)'; suggestDiv.innerText = "";
                }
                text.innerText = json.message;
                document.getElementById('guardian-step-1').classList.add('hidden'); document.getElementById('guardian-result').classList.remove('hidden');
            } catch(e) { alert("Erro ao ler JSON. Cole apenas o c√≥digo."); }
        }

        function confirmGuardianSpend() {
            const item = document.getElementById('g-item').value; const price = document.getElementById('g-price').value;
            closeModals(); openTransModal('out');
            document.getElementById('t-desc').value = item; document.getElementById('t-amt').value = price;
            if(guardianSuggestedBoxId) { const sel = document.getElementById('t-box'); sel.value = guardianSuggestedBoxId; checkSourceSelected(sel); }
        }
        function recordVictory() { alert("üèÜ VIT√ìRIA! O general est√° orgulhoso."); closeModals(); }

        // --- EXISTING FUNCTIONS ---
        function getGhConfig() { return { token: localStorage.getItem('nbv_gh_token'), user: localStorage.getItem('nbv_gh_user'), repo: localStorage.getItem('nbv_gh_repo'), file: localStorage.getItem('nbv_gh_file') || 'nbv_data.json' }; }
        function saveGithubConfig() {
            const token = document.getElementById('gh-token').value.trim(); const user = document.getElementById('gh-user').value.trim(); const repo = document.getElementById('gh-repo').value.trim(); const file = document.getElementById('gh-file').value.trim();
            if(!token) return alert('Preencha os dados!');
            localStorage.setItem('nbv_gh_token', token); localStorage.setItem('nbv_gh_user', user); localStorage.setItem('nbv_gh_repo', repo); localStorage.setItem('nbv_gh_file', file);
            closeModals(); attemptGithubLoad();
        }
        function openGithubConfig() {
            const cfg = getGhConfig();
            document.getElementById('gh-token').value = cfg.token || ''; document.getElementById('gh-user').value = cfg.user || ''; document.getElementById('gh-repo').value = cfg.repo || ''; document.getElementById('gh-file').value = cfg.file || 'nbv_data.json';
            document.getElementById('modal-config').classList.remove('active'); document.getElementById('modal-github').classList.add('active');
        }
        function forceReconnect() { if(confirm("ATEN√á√ÉO: Isso vai apagar a configura√ß√£o local e reconectar do zero. Continuar?")) { localStorage.clear(); location.reload(); } }
        function showStatus(msg, type) { const el = document.getElementById('status-indicator'); el.innerText = msg; el.className = `status-pill status-${type}`; el.classList.remove('hidden'); if(type === 'saved') setTimeout(() => el.classList.add('hidden'), 3000); }
        function toggleGlobalLoading(show) { document.getElementById('global-loading').style.display = show ? 'flex' : 'none'; }
        function utf8_to_b64(str) { return window.btoa(unescape(encodeURIComponent(str))); }
        function b64_to_utf8(str) { return decodeURIComponent(escape(window.atob(str))); }
        async function getLatestSha() { const cfg = getGhConfig(); const url = `https://api.github.com/repos/${cfg.user}/${cfg.repo}/contents/${cfg.file}?t=${Date.now()}`; const res = await fetch(url, { headers: { 'Authorization': `token ${cfg.token}`, 'Accept': 'application/vnd.github.v3+json', 'If-None-Match': '' } }); if(res.ok) { const data = await res.json(); return data.sha; } return null; }
        async function attemptGithubLoad() { const cfg = getGhConfig(); if(!cfg.token) { openGithubConfig(); return; } document.getElementById('welcome-btns').classList.add('hidden'); document.getElementById('welcome-loading').classList.remove('hidden'); const url = `https://api.github.com/repos/${cfg.user}/${cfg.repo}/contents/${cfg.file}?t=${Date.now()}`; try { const res = await fetch(url, { headers: { 'Authorization': `token ${cfg.token}`, 'Accept': 'application/vnd.github.v3+json', 'If-None-Match': '' } }); if(res.status === 404) { alert(`Erro 404: Arquivo n√£o encontrado.`); document.getElementById('welcome-loading').classList.add('hidden'); document.getElementById('welcome-btns').classList.remove('hidden'); return; } if(!res.ok) throw new Error("Erro Github: " + res.status); const data = await res.json(); currentSha = data.sha; const content = b64_to_utf8(data.content); const loaded = JSON.parse(content); if(!loaded.bills) loaded.bills = []; loaded.boxes.forEach(b => { if(!b.mode) b.mode='monthly'; if(!b.subItems) b.subItems=[]; }); appData = loaded; showStatus("Conectado", "saved"); initNewSystem(); } catch(e) { console.error(e); alert("Falha na conex√£o: " + e.message); document.getElementById('welcome-loading').classList.add('hidden'); document.getElementById('welcome-btns').classList.remove('hidden'); } }
        async function forceSaveGitHub() { const cfg = getGhConfig(); if(!cfg.token || isSaving) return; isSaving = true; toggleGlobalLoading(true); showStatus("Salvando...", "sync"); try { const freshSha = await getLatestSha(); if(freshSha) currentSha = freshSha; const url = `https://api.github.com/repos/${cfg.user}/${cfg.repo}/contents/${cfg.file}`; const body = { message: "Update NBV Data [skip ci]", content: utf8_to_b64(JSON.stringify(appData)), sha: currentSha }; const res = await fetch(url, { method: 'PUT', headers: { 'Authorization': `token ${cfg.token}`, 'Content-Type': 'application/json' }, body: JSON.stringify(body) }); if(!res.ok) throw new Error("Erro Save: " + res.status); const data = await res.json(); currentSha = data.content.sha; showStatus("Salvo", "saved"); } catch(e) { showStatus("Erro ao Salvar", "error"); alert("Erro ao salvar! Tente novamente."); } finally { isSaving = false; toggleGlobalLoading(false); } }
        function sanitizeBills() { const m=new Date().getMonth(), y=new Date().getFullYear(); appData.bills = appData.bills.filter(b => !b.isAuto || !appData.transactions.some(t => new Date(t.date).getMonth()===m && new Date(t.date).getFullYear()===y && t.desc.toLowerCase().includes(b.desc.toLowerCase()) && (t.type==='out'||t.type==='deleted-auto'))); }
        function autoGenerateBills() { const today = new Date(); const k = `${today.getFullYear()}-${today.getMonth()}`; appData.boxes.forEach(b => { if(b.subItems) b.subItems.forEach(i => { if(i.dueDay && i.freq==='monthly') { const bid = `auto_${b.id}_${i.name.replace(/\s/g,'')}_${k}`; const isResolved = appData.transactions.some(t => new Date(t.date).getMonth()===today.getMonth() && t.desc.toLowerCase().includes(i.name.toLowerCase()) && (t.type==='out'||t.type==='deleted-auto')); if(!appData.bills.find(x=>x.autoId===bid) && !isResolved) appData.bills.push({id:Date.now()+Math.random(), autoId:bid, desc:i.name, val:i.val, date:new Date(today.getFullYear(),today.getMonth(),i.dueDay).toISOString().split('T')[0], boxId:b.id, isAuto:true}); } })}); }
        
        // --- MANUAL AI DISTRIBUTION (UPDATED PROMPT) ---
        function openManualAIDistribution() { 
            const avail = appData.masterBalance; if(avail <= 0) return alert('Sem saldo.'); 
            const urgentBills = appData.bills.reduce((sum, b) => sum + b.val, 0);
            
            const context = {
                currentDate: new Date().toISOString().split('T')[0],
                availableFunds: avail,
                ACTUAL_PENDING_BILLS_TOTAL: urgentBills,
                pending_bills_list: appData.bills.map(b => `${b.desc} (${fmt(b.val)})`),
                box_structure_reference: appData.boxes.map(b=>({name:b.label, current:b.current, target:b.target, mode:b.mode, subItems:b.subItems}))
            };
            const prompt = `Sou o Thiago (Warrior, TDAH). Saldo: ${avail}.\nDADOS:\n${JSON.stringify(context)}\nMISS√ÉO:\n1. Distribua o saldo.\n2. CRUCIAL: Use 'ACTUAL_PENDING_BILLS_TOTAL' para saber o que devo. Se um item da 'box_structure' n√£o estiver na 'pending_bills_list', √â PORQUE J√Å FOI PAGO. IGNORE-O.\nPrioridade: Contas da lista de pend√™ncias > Caixas Negativas > Projetos P1 > Reserva.\nResponda JSON: { "insight": "Resumo", "plan": [{ "name": "NomeCaixa", "val": 0, "reason": "Motivo" }] }`; 
            document.getElementById('ai-prompt-output').value = prompt; document.getElementById('modal-manual-ai').classList.add('active'); 
        }
        function copyPrompt() { const t=document.getElementById('ai-prompt-output'); t.select(); document.execCommand('copy'); alert("Copiado!"); }
        function processManualAI() { try { const j = JSON.parse(document.getElementById('ai-json-input').value.replace(/```json/g,'').replace(/```/g,'').trim()); const plan = j.plan.map(p => { const b = appData.boxes.find(x=>x.label.toLowerCase()===p.name.toLowerCase()); return { id: b?b.id:'gerais', name:b?b.label:p.name, val:p.val, reason:p.reason }; }); document.getElementById('modal-manual-ai').classList.remove('active'); renderDistModal(plan, j.insight); } catch(e) { alert("Erro JSON: "+e.message); } }
        function renderDistModal(plan, insight) { document.getElementById('ai-insight').innerText = "‚öîÔ∏è " + insight; const l = document.getElementById('distribution-list'); l.innerHTML=''; plan.forEach(i => { if(i.val>0.01) l.innerHTML+=`<div style="background:#222; padding:10px; margin-bottom:5px; border-radius:5px; display:flex; justify-content:space-between; align-items:center;"><div>${i.name}<div style="font-size:0.7rem; color:#aaa">${i.reason}</div></div><input type="number" class="dist-inp" data-id="${i.id}" value="${i.val.toFixed(2)}" style="width:100px; background:#000; border:1px solid #444; color:white; padding:5px; text-align:right;" oninput="recalcDist()"></div>`; }); document.getElementById('modal-distribute').classList.add('active'); recalcDist(); }
        
        async function commitDistribution() {
            let total = 0; const inputs = document.querySelectorAll('.dist-inp');
            inputs.forEach(i => total += parseFloat(i.value || 0));
            if(total > appData.masterBalance + 0.1) return alert(`Saldo insuficiente!`);
            inputs.forEach(i => { const val = parseFloat(i.value || 0); if(val > 0) { const box = appData.boxes.find(b => b.id === i.dataset.id); if(box) { box.current += val; appData.transactions.push({ id: Date.now(), date: new Date().toISOString(), type: 'dist', amount: val, desc: 'IA Distribui√ß√£o', box: box.id }); } } });
            appData.masterBalance -= total; closeModals(); renderDashboard(); await forceSaveGitHub();
        }

        function openBillModal() { const s=document.getElementById('b-box'); s.innerHTML=''; appData.boxes.forEach(b=>s.innerHTML+=`<option value="${b.id}">${b.label}</option>`); document.getElementById('b-id').value=''; document.getElementById('b-desc').value=''; document.getElementById('b-val').value=''; document.getElementById('b-date').value=new Date().toISOString().split('T')[0]; document.getElementById('modal-bill').classList.add('active'); }
        function editBill(id) { const b=appData.bills.find(x=>x.id===id); if(!b)return; const s=document.getElementById('b-box'); s.innerHTML=''; appData.boxes.forEach(bx=>s.innerHTML+=`<option value="${bx.id}">${bx.label}</option>`); document.getElementById('b-id').value=b.id; document.getElementById('b-desc').value=b.desc; document.getElementById('b-val').value=b.val; document.getElementById('b-date').value=b.date; document.getElementById('b-box').value=b.boxId; document.getElementById('modal-bill').classList.add('active'); }
        function openTransModal(t) { transType=t; document.getElementById('t-title').innerText=t==='in'?'Entrada':'Sa√≠da'; document.getElementById('box-select-div').classList.toggle('hidden', t==='in'); document.getElementById('t-amt').value=''; document.getElementById('t-desc').value=''; if(t==='out'){ const s=document.getElementById('t-box'); s.innerHTML=`<option value="master">Caixa Mestra (${fmt(appData.masterBalance)})</option>`; appData.boxes.forEach(b=>s.innerHTML+=`<option value="${b.id}">${b.label}</option>`); checkSourceSelected(s); } document.getElementById('modal-trans').classList.add('active'); }
        function checkSourceSelected(s) { const b = appData.boxes.find(x=>x.id===s.value); const isC = b?.mode==='credit' || s.value==='master'; document.getElementById('ref-box-div').classList.toggle('hidden', !isC); if(isC){ const r=document.getElementById('t-ref-box'); r.innerHTML='<option value="">Geral</option>'; appData.boxes.forEach(x=>{if(x.mode!=='credit')r.innerHTML+=`<option value="${x.id}">${x.label}</option>`}); } }
        async function commitTrans() { const a=parseFloat(document.getElementById('t-amt').value), d=document.getElementById('t-desc').value; if(!a)return; if(transType==='in'){appData.masterBalance+=a; appData.transactions.push({id:Date.now(),date:new Date().toISOString(),type:'in',amount:a,desc:d,box:'master'});} else { const bid=document.getElementById('t-box').value; let ref=null; if(bid==='master'){appData.masterBalance-=a; ref=document.getElementById('t-ref-box').value;} else { const b=appData.boxes.find(x=>x.id===bid); if(b.mode==='credit'){b.current+=a; ref=document.getElementById('t-ref-box').value;} else {b.current-=a;} } appData.transactions.push({id:Date.now(),date:new Date().toISOString(),type:'out',amount:a,desc:d,box:bid,refBox:ref}); } closeModals(); renderDashboard(); await forceSaveGitHub(); }
        function openBillPayModal(id) { const b=appData.bills.find(x=>x.id===id); if(!b)return; document.getElementById('pay-desc-display').innerText=b.desc; document.getElementById('pay-val-expected').innerText=fmt(b.val); document.getElementById('pay-val-real').value=b.val; document.getElementById('pay-id-target').value=b.id; const s=document.getElementById('pay-method'); s.innerHTML='<option value="cash">Saldo Caixa</option>'; if(appData.boxes.find(x=>x.mode==='credit')) s.innerHTML+='<option value="credit">Cart√£o Cr√©dito</option>'; s.innerHTML+='<option value="master">Caixa Mestra</option>'; document.getElementById('modal-pay-confirm').classList.add('active'); }
        async function commitPayment() { const id=parseFloat(document.getElementById('pay-id-target').value), rv=parseFloat(document.getElementById('pay-val-real').value), m=document.getElementById('pay-method').value; if(!rv)return; const idx=appData.bills.findIndex(x=>x.id===id), bill=appData.bills[idx], org=appData.boxes.find(x=>x.id===bill.boxId); if(m==='credit'){ const cc=appData.boxes.find(x=>x.mode==='credit'); cc.current+=rv; appData.transactions.push({id:Date.now(),date:new Date().toISOString(),type:'out',amount:rv,desc:`PGTO(CC): ${bill.desc}`,box:cc.id,refBox:org.id}); } else if(m==='master') { if(appData.masterBalance<rv)return alert('Sem saldo'); appData.masterBalance-=rv; appData.transactions.push({id:Date.now(),date:new Date().toISOString(),type:'out',amount:rv,desc:`PGTO(Mestra): ${bill.desc}`,box:'master',refBox:org.id}); } else { if(org.current<rv)return alert('Sem saldo caixa'); org.current-=rv; appData.transactions.push({id:Date.now(),date:new Date().toISOString(),type:'out',amount:rv,desc:`PGTO: ${bill.desc}`,box:org.id}); } appData.bills.splice(idx,1); closePayModal(); renderBills(); renderDashboard(); await forceSaveGitHub(); }
        async function safeDeleteBill(id) { const idx=appData.bills.findIndex(x=>x.id===id); if(idx===-1)return; const b=appData.bills[idx]; if(confirm("Excluir?")){ if(b.isAuto) appData.transactions.push({id:Date.now(),date:new Date().toISOString(),type:'deleted-auto',amount:0,desc:`Baixa: ${b.desc}`,box:b.boxId}); appData.bills.splice(idx,1); renderBills(); await forceSaveGitHub(); renderDashboard(); } }
        function closePayModal(){document.getElementById('modal-pay-confirm').classList.remove('active');}
        function closeModals(){document.querySelectorAll('.modal-overlay').forEach(x=>x.classList.remove('active'));}
        function exportCSV() { /* same */ }
        function fmt(v) { return v.toLocaleString('pt-BR', {style:'currency', currency:'BRL'}); }
        function switchTab(t) { ['dashboard','bills','reports'].forEach(x=>{document.getElementById('tab-'+x).classList.add('hidden'); document.getElementById('btn-'+ (x==='dashboard'?'dash':(x==='bills'?'bills':'reports'))).classList.remove('active');}); document.getElementById('tab-'+t).classList.remove('hidden'); document.getElementById('btn-'+ (t==='dashboard'?'dash':(t==='bills'?'bills':'reports'))).classList.add('active'); if(t==='bills') renderBills(); if(t==='reports') generateReport(); }
        
        function renderDashboard() {
            document.getElementById('master-balance').innerText = fmt(appData.masterBalance);
            const container = document.getElementById('boxes-container'); container.innerHTML = '';
            appData.boxes.forEach(box => {
                let visualHtml = '', statusText = '', extraClass = '';
                if (box.mode === 'monthly') {
                    const target = box.target || 1; let months = box.current / target; if(box.current < 0) months = 0; if(box.current < 0) extraClass = 'negative';
                    let barsHtml = ''; for(let i=0; i<6; i++) { let fill = (months > i) ? ((months >= i+1) ? 100 : (months - i) * 100) : 0; let colorClass = (i===0) ? 'fill-lvl-1' : (months >= 6 ? 'fill-lvl-max' : 'fill-lvl-future'); barsHtml += `<div class="shield-segment"><div class="shield-fill ${colorClass}" style="width:${fill}%"></div></div>`; }
                    visualHtml = `<div class="shield-track">${barsHtml}</div>`; statusText = box.current < 0 ? 'üö® NEGATIVO' : months.toFixed(1) + ' Meses Cobertos';
                } else if (box.mode === 'target') {
                    const target = box.target || 1; const pct = Math.min((box.current / target)*100, 100);
                    visualHtml = `<div class="progress-track"><div class="progress-bar" style="width:${pct}%"></div><div style="position:absolute; right:5px; top:0; font-size:0.7rem; color:white; line-height:12px;">${pct.toFixed(0)}%</div></div>`; 
                    statusText = `Objetivo: ${fmt(target)}`;
                } else if (box.mode === 'credit') { extraClass = 'credit-mode'; visualHtml = `<div style="height:5px; background:#444; border-radius:2px; margin-top:5px;"></div>`; statusText = `Vence dia ${box.dueDay || '?'}`; }
                container.innerHTML += `<div class="box-card ${extraClass}" style="border-top: 3px solid ${box.color}"><div style="display:flex; justify-content:space-between;"><span style="font-weight:bold; color:${box.color}">${box.label}</span><span style="font-size:0.7rem; color:#888; text-transform:uppercase; border:1px solid #444; padding:2px 4px; border-radius:3px;">${box.mode}</span></div><div class="box-val" style="color:${box.mode==='credit'?'#ffcc00':'white'}">${fmt(box.current)}</div>${visualHtml}<div style="font-size:0.75rem; color:#666; margin-top:5px;">${statusText}</div></div>`;
            });
            updateBadge();
        }

        function renderBills() {
            const l=document.getElementById('bill-list'); l.innerHTML=''; 
            if(appData.bills.length===0) l.innerHTML='<div style="text-align:center;color:#666">Sem contas.</div>'; 
            appData.bills.sort((a,b)=>new Date(a.date)-new Date(b.date)).forEach(b=>{ 
                const box=appData.boxes.find(x=>x.id===b.boxId); 
                l.innerHTML+=`<div class="bill-card ${b.isAuto?'auto-gen':''}"><div class="bill-header"><div><strong style="color:white">${b.desc}</strong><div style="color:var(--danger)">${fmt(b.val)}</div><div style="font-size:0.8rem;color:#888">${new Date(b.date).toLocaleDateString()} | ${box?box.label:'?'}</div></div></div><div class="bill-actions"><button class="btn-icon" onclick="editBill(${b.id})">‚úèÔ∏è</button><button class="btn-icon" style="background:#500" onclick="deleteBill(${b.id})">üóëÔ∏è</button><button class="btn-action btn-in" style="flex:1; padding:8px" onclick="openBillPayModal(${b.id})">PAGAR</button></div></div>`; 
            });
        }
        
        function updateBadge() { const b = document.getElementById('bill-badge'); b.innerText = appData.bills.length; b.classList.toggle('hidden', appData.bills.length === 0); }
        function generateReport() { const s=document.getElementById('rep-start').value, e=document.getElementById('rep-end').value; const txs=appData.transactions.filter(t=>{const d=new Date(t.date); return d>=new Date(s) && d<=new Date(e+'T23:59:59')}); let i=0, o=0; txs.forEach(t=>{if(t.type==='in')i+=t.amount;else if(t.type==='out')o+=t.amount;}); document.getElementById('rep-in').innerText=fmt(i); document.getElementById('rep-out').innerText=fmt(o); document.getElementById('rep-bal').innerText=fmt(i-o); const tb=document.getElementById('rep-table-body'); tb.innerHTML=''; txs.sort((a,b)=>new Date(b.date)-new Date(a.date)).forEach(t=>{ tb.innerHTML+=`<tr><td>${new Date(t.date).toLocaleDateString()}</td><td>${t.desc}</td><td>${t.box}</td><td style="color:${t.type==='in'?'green':'red'}">${fmt(t.amount)}</td></tr>`; }); }
        function renderBarChart(elId,dataObj,totalRef,color) { const el=document.getElementById(elId); el.innerHTML=''; const sorted=Object.entries(dataObj).sort((a,b)=>b[1]-a[1]); if(sorted.length===0){el.innerHTML='<div style="color:#666;font-size:0.8rem;text-align:center">Sem dados.</div>';return;} const maxVal=sorted[0][1]; sorted.forEach(([label,val])=>{ const barWidth=(val/maxVal)*100; el.innerHTML+=`<div class="bar-row"><div class="bar-label">${label.substring(0,12)}</div><div class="bar-track"><div class="bar-fill" style="width:${barWidth}%; background:${color}"></div></div><div class="bar-val">${fmt(val)}</div></div>`; }); }
        
        // --- MISSING SAFETY CHECK ADDED HERE ---
        function renderSubItems() { 
            const box = appData.boxes[currentBoxIdx]; 
            const list = document.getElementById('subitems-list'); 
            const totalEl = document.getElementById('detail-total');
            
            if(!list || !totalEl) return; // SAFETY CHECK

            list.innerHTML = ''; 
            let totalCalc = 0; 
            box.subItems.forEach((item, i) => { 
                let label = ''; 
                if(item.freq === 'annual') { 
                    label = ' (Anual)'; 
                    if(box.mode === 'monthly') totalCalc += (item.val/12); 
                    else totalCalc += item.val; 
                } else if(item.freq === 'custom') { 
                    label = ` (${item.parts}x)`; 
                    if(box.mode === 'monthly') totalCalc += (item.val/item.parts); 
                    else totalCalc += item.val; 
                } else { 
                    if(box.mode === 'monthly') totalCalc += item.val; 
                    else totalCalc += item.val; 
                } 
                let dayInfo = item.dueDay ? ` <span style="color:var(--primary)">[Dia ${item.dueDay}]</span>` : ''; 
                let pBadge = item.priority === '1' ? '<span class="p-badge p-1">P1</span>' : (item.priority === '2' ? '<span class="p-badge p-2">P2</span>' : '<span class="p-badge p-3">P3</span>'); 
                list.innerHTML += `<div style="display:flex; justify-content:space-between; background:#111; padding:8px; margin-bottom:5px; border-radius:5px;"><span>${item.name} ${pBadge} <small style="color:#888">${label}${dayInfo}</small></span><span>${fmt(item.val)} <span onclick="delSubItem(${i})" style="color:red; cursor:pointer; margin-left:10px; font-weight:bold;">‚úï</span></span></div>`; 
            }); 
            box.target = totalCalc; 
            totalEl.innerText = fmt(totalCalc); // SAFE SET
        }
        function addSubItem() { const name = document.getElementById('new-item-name').value; const val = parseFloat(document.getElementById('new-item-val').value); const freq = document.getElementById('new-item-freq').value; const priority = document.getElementById('new-item-priority').value; const parts = parseFloat(document.getElementById('new-item-parts').value) || 1; const dueDay = parseInt(document.getElementById('new-item-day').value) || null; if(name && val) { appData.boxes[currentBoxIdx].subItems.push({name, val, freq, parts, dueDay, priority}); renderSubItems(); document.getElementById('new-item-name').value = ''; document.getElementById('new-item-val').value = ''; } }
        function delSubItem(i) { appData.boxes[currentBoxIdx].subItems.splice(i, 1); renderSubItems(); }
        function closeDetailModal() { document.getElementById('modal-detail').classList.remove('active'); openConfigModal(); renderDashboard(); }
        function addNewBox() { const n=prompt("Nome:"); if(n) { appData.boxes.push({id:'box_'+Date.now(),label:n,color:'#fff',priority:2,mode:'monthly',subItems:[],target:0,current:0}); openConfigModal(); } }
        async function updateBalance(i,v) { let val=parseFloat(v); let d=val-appData.boxes[i].current; if(d!==0) { appData.boxes[i].current=val; appData.transactions.push({id:Date.now(),date:new Date().toISOString(),type:d>0?'in':'out',amount:Math.abs(d),desc:'Ajuste Manual',box:appData.boxes[i].id}); renderDashboard(); await forceSaveGitHub(); } }
        function commitInvoicePay() { /* Same as before */ }
        function calcInvTotal() { /* Same as before */ }

        window.onload = function() { if(getGhConfig().token) attemptGithubLoad(); }
    </script>
</body>
</html>
